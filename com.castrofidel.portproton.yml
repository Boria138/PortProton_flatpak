app-id: com.castrofidel.portproton
sdk: org.gnome.Sdk
runtime: org.gnome.Platform
runtime-version: "44"
command: portproton
separate-locales: false

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio
  # Fix "pressure-vessel-wrap[20452]: W: /dev/shm not shared between app instances" error
  - --allow=per-app-dev-shm
  - --device=all
  - --share=network
  - --allow=multiarch
  # For Wine crash handling
  - --allow=devel
  # XDG
  - --filesystem=xdg-desktop
  - --filesystem=xdg-documents
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-videos
  - --filesystem=xdg-data
  # Need to link .desktop files
  - --filesystem=~/.local/share/applications:create
  # Wine uses UDisks2 to enumerate disk drives
  - --system-talk-name=org.freedesktop.UDisks2
  # For mangohud config
  - --filesystem=xdg-config/MangoHud:ro
  # Should fix access to SD card on the deck
  - --filesystem=/run/media
  # Should fix steamdeck controler navigation
  - --filesystem=/run/udev:ro
  # For Debian
  - --filesystem=/media
  # ENV
  - --env=GST_PLUGIN_SYSTEM_PATH=/app/lib/gstreamer-1.0:/usr/lib/x86_64-linux-gnu/gstreamer-1.0:/app/lib32/gstreamer-1.0:/usr/lib/i386-linux-gnu/gstreamer-1.0
  - --env=LD_LIBRARY_PATH=/app/lib:/app/lib32
  - --env=PATH=/app/bin:/app/utils/bin:/usr/bin:/usr/lib/extensions/vulkan/MangoHud/bin:/usr/lib/extensions/vulkan/OBSVkCapture/bin
  # System tray icon
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.freedesktop.Flatpak
  # Need to link ~/.var/com.castrofidel.portproton/data to $HOME
  - --filesystem=home

add-extensions:

  org.gnome.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: "44"

  org.freedesktop.Platform.GL32:
    directory: lib/i386-linux-gnu/GL
    version: '1.4'
    versions: 22.08;1.4
    subdirectories: true
    no-autodownload: true
    autodelete: false
    add-ld-path: lib
    merge-dirs: vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d;vulkan/implicit_layer.d
    download-if: active-gl-driver
    enable-if: active-gl-driver
    
  com.valvesoftware.Steam.Utility:
    subdirectories: true
    directory: utils
    version: stable
    versions: stable;beta;test
    add-ld-path: lib
    merge-dirs: bin
    no-autodownload: true
    autodelete: true

x-compat-i386-opts: &compat_i386_opts
  prepend-pkg-config-path: /app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig
  ldflags: -L/app/lib32
  append-path: /usr/lib/sdk/toolchain-i386/bin
  env:
    CC: i686-unknown-linux-gnu-gcc
    CXX: i686-unknown-linux-gnu-g++
  libdir: /app/lib32
  
sdk-extensions:
  - org.gnome.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.toolchain-i386

cleanup:
  - /include
  - /lib*/pkgconfig
  - /man
  - /share/doc
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - "*.la"
  - "*.a"
    
modules:

  # Tools
  # ----------------------------------------------------------------------------
  
  - name: xmu
    buildsystem: autotools
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: https://www.x.org/releases/individual/lib/libXmu-1.1.4.tar.gz
        sha256: 3091d711cdc1d8ea0f545a13b90d1464c3c3ab64778fd121f0d789b277a80289

  - name: xrdb
    buildsystem: autotools
    sources:
      - type: archive
        url: https://www.x.org/releases/individual/app/xrdb-1.2.2.tar.gz
        sha256: db2d774a35ae2f7e7ac61cc2de0dcae27fc2aa14399c35721f8300e63ea73549

  - name: wmctrl
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/saravanabalagi/wmctrl
        commit: 7ecfd2adaa2726a0c974b30bd6df2a65094032dd
    build-commands:
      - ./configure --prefix=/app
      - make
      - make install PREFIX=/app

  - name: gamemode
    buildsystem: meson
    config-opts: &gamemode_config_opts
      - -Dwith-examples=false
      - -Dwith-util=false
      - -Dwith-sd-bus-provider=no-daemon
    post-install:
      - install -Dm0775 -t /app/bin ../data/gamemoderun
    sources: &gamemode_sources
      - type: archive
        url: https://github.com/FeralInteractive/gamemode/releases/download/1.7/gamemode-1.7.tar.xz
        sha256: c1860f76f1d4c0d6e3965e52de21c824f24791049946da728da50f0c63748389
        x-checker-data:
          type: anitya
          project-id: 17410
          stable-only: true
          url-template: https://github.com/FeralInteractive/gamemode/releases/download/$version/gamemode-$version.tar.xz

  - name: gamemode-32bit
    build-options:
      arch:
        x86_64: *compat_i386_opts
    buildsystem: meson
    config-opts: *gamemode_config_opts
    sources: *gamemode_sources
                
  - name: platform-bootstrap
    buildsystem: simple
    build-commands:
      - |
        set -e
        mkdir -p /app/bin
        mkdir -p /app/utils
        mkdir -p /app/lib/i386-linux-gnu
        mkdir -p /app/lib/i386-linux-gnu/GL
        install -Dm644 com.castrofidel.portproton.svg /app/share/icons/hicolor/scalable/apps/com.castrofidel.portproton.svg
        install -Dm644 com.castrofidel.portproton.desktop /app/share/applications/${FLATPAK_ID}.desktop
        install -D portproton -t /app/bin
        install -Dm644 -t /app/etc ld.so.conf
        install -Dm644 $FLATPAK_ID.metainfo.xml /app/share/metainfo/$FLATPAK_ID.appdata.xml
    sources:
      - type: inline
        dest-filename: ld.so.conf
        contents: |
          /app/lib32
          /app/lib/i386-linux-gnu
      - type: file
        path: com.castrofidel.portproton.metainfo.xml
      - type: file
        path: com.castrofidel.portproton.svg
      - type: file
        path: portproton
      - type: file
        path: com.castrofidel.portproton.desktop

  - name: desktop-file-utils
    buildsystem: meson
    sources:
      - type: archive
        url: https://www.freedesktop.org/software/desktop-file-utils/releases/desktop-file-utils-0.26.tar.xz
        sha256: b26dbde79ea72c8c84fb7f9d870ffd857381d049a86d25e0038c4cef4c747309
        
  - name: vulkan-tools
    buildsystem: cmake-ninja
    config-opts:
      - -DGLSLANG_INSTALL_DIR=/app
      - -DVULKAN_HEADERS_INSTALL_DIR=/app
      - -DCMAKE_BUILD_TYPE=Release
    sources:
      - type: git
        url: https://github.com/KhronosGroup/Vulkan-Tools.git
        tag: sdk-1.3.224.1
        commit: 497f232680b046db34ba9e9da065e6303a125851

  - name: icoutils
    buildsystem: autotools
    sources:
      - type: archive
        url: http://savannah.nongnu.org/download/icoutils/icoutils-0.32.3.tar.bz2
        mirror-urls: 
          - https://download-mirror.savannah.gnu.org/releases/icoutils/icoutils-0.32.3.tar.bz2
          - https://ftp.up.pt/pub/nongnu/icoutils/icoutils-0.32.3.tar.bz2
        sha256: 17abe02d043a253b68b47e3af69c9fc755b895db68fdc8811786125df564c6e0

  - name: cabextract
    sources:
      - type: archive
        url: https://www.cabextract.org.uk/cabextract-1.11.tar.gz
        sha256: b5546db1155e4c718ff3d4b278573604f30dd64c3c5bfd4657cd089b823a3ac6
        x-checker-data:
          type: anitya
          project-id: 245
          url-template: https://www.cabextract.org.uk/cabextract-$version.tar.gz

        
  # Libraries
  # ----------------------------------------------------------------------------

  - name: ImageMagick
    config-opts:
      - --disable-static
      - --disable-docs
      - --with-hdri
      - --with-pic
    sources:
      - type: archive
        url: https://github.com/ImageMagick/ImageMagick/archive/7.1.1-12.tar.gz
        sha256: 51567d11fcbca5bd591d191ce9fdf821e2ed1b12c1ad8bc2a2f13da5c6313f33

  - name: libportal
    buildsystem: meson
    config-opts:
      - -Ddocs=false
      - -Dbackends=gtk4
    sources:
      - type: archive
        url: https://github.com/flatpak/libportal/archive/refs/tags/0.6.tar.gz
        sha256: 8ad326c4f53b7433645dc86d994fef0292bee8adda0fe67db9288ace19250a9c
  
  # Port Proton deps
  # ----------------------------------------------------------------------------
  
  - name: zenity
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/GNOME/zenity/archive/refs/tags/3.99.0.tar.gz
        sha256: b2c8fd9bdda9158f9b7b4ef8f33c97ae6e76806d035ae911c95fbcf9f0ccd6f6

  - name: bubblewrap
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/containers/bubblewrap/releases/download/v0.8.0/bubblewrap-0.8.0.tar.xz
        sha256: 957ad1149db9033db88e988b12bcebe349a445e1efc8a9b59ad2939a113d333a
