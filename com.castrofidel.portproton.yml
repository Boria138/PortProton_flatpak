app-id: com.castrofidel.portproton
sdk: org.gnome.Sdk
runtime: org.gnome.Platform
base: org.winehq.Wine
base-version: stable-22.08
runtime-version: "44"
command: portproton

sdk-extensions:
  - org.gnome.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.toolchain-i386

cleanup:
  - /include
  - /lib/pkgconfig
  - /man
  - /share/doc
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - "*.la"
  - "*.a"

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio
  - --device=all
  - --share=network
  - --allow=multiarch
  # For Wine crash handling
  - --allow=devel
  - --talk-name=org.gnome.Mutter.DisplayConfig
  - --system-talk-name=org.freedesktop.UDisks2
  - --filesystem=host:rw
  - --require-version=1.1.2
  # Should fix discord rich presence
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  - --filesystem=xdg-documents
  - --filesystem=xdg-desktop
  - --filesystem=xdg-download
  # For mangohud config
  - --filesystem=xdg-config/MangoHud:ro
  # Should fix access to SD card on the deck
  - --filesystem=/run/media
  # Should fix steamdeck controler navigation
  - --filesystem=/run/udev:ro
  # For Debian
  - --filesystem=/media
  - --env=GST_PLUGIN_SYSTEM_PATH=/app/lib/gstreamer-1.0:/usr/lib/x86_64-linux-gnu/gstreamer-1.0:/app/lib32/gstreamer-1.0:/usr/lib/i386-linux-gnu/gstreamer-1.0
  - --env=LD_LIBRARY_PATH=/app/lib:/app/lib32
  - --env=PATH=/app/bin:/app/utils/bin:/usr/bin:/usr/lib/extensions/vulkan/MangoHud/bin:/usr/lib/extensions/vulkan/OBSVkCapture/bin
  # System tray icon
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.freedesktop.Flatpak
  - --filesystem=xdg-data/flatpak:ro
  # Needed for appimages
  - --env=APPIMAGE_EXTRACT_AND_RUN=1

inherit-extensions:
  - org.freedesktop.Platform.GL32
  - org.freedesktop.Platform.ffmpeg-full
  - org.freedesktop.Platform.ffmpeg_full.i386
  - org.winehq.Wine.DLLs

add-extensions:
  org.gnome.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: '44'

  x-compat-i386-opts: &compat_i386_opts
    prepend-pkg-config-path: /app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig
    ldflags: -L/app/lib32
    append-path: /usr/lib/sdk/toolchain-i386/bin
    env:
      CC: i686-unknown-linux-gnu-gcc
      CXX: i686-unknown-linux-gnu-g++
    libdir: /app/lib32

  org.freedesktop.Platform.GL32:
    directory: lib/i386-linux-gnu/GL
    version: '1.4'
    versions: 44;1.4
    subdirectories: true
    no-autodownload: true
    autodelete: false
    add-ld-path: lib
    merge-dirs: vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d;vulkan/implicit_layer.d
    download-if: active-gl-driver
    enable-if: active-gl-driver

  x-compat-i386-opts: &compat_i386_opts
    prepend-pkg-config-path: /app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig
    ldflags: -L/app/lib32
    append-path: /usr/lib/sdk/toolchain-i386/bin
    env:
      CC: i686-unknown-linux-gnu-gcc
      CXX: i686-unknown-linux-gnu-g++
    libdir: /app/lib32

  org.freedesktop.Platform.VAAPI.Intel.i386:
    directory: lib/i386-linux-gnu/dri/intel-vaapi-driver
    version: '44'
    versions: '44'
    autodelete: false
    no-autodownload: true
    add-ld-path: lib
    download-if: have-intel-gpu
    autoprune-unless: have-intel-gpu

  com.valvesoftware.Steam.Utility:
    subdirectories: true
    directory: utils
    version: stable
    versions: stable;beta;test
    add-ld-path: lib
    merge-dirs: bin
    no-autodownload: true
    autodelete: true
    
modules:

  # Tools
  # ----------------------------------------------------------------------------

  - name: xmu
    buildsystem: autotools
    sources:
      - type: archive
        url: https://www.x.org/releases/individual/lib/libXmu-1.1.2.tar.bz2
        sha256: 756edc7c383254eef8b4e1b733c3bf1dc061b523c9f9833ac7058378b8349d0b

  - name: wmctrl
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/saravanabalagi/wmctrl
    build-commands:
      - ./configure --prefix=/app
      - make
      - make install PREFIX=/app

  - name: gamemode
    buildsystem: meson
    config-opts: &gamemode_opts
      - -Dwith-examples=false
      - -Dwith-util=false
      - -Dwith-sd-bus-provider=no-daemon
    sources: &gamemode_sources
      - type: git
        url: https://github.com/FeralInteractive/gamemode.git
        tag: '1.7'
        commit: 4dc99dff76218718763a6b07fc1900fa6d1dafd9
        x-checker-data:
          type: git

  - name: gamemode-32bit
    build-options:
      arch:
        x86_64: *compat_i386_opts
    buildsystem: meson
    config-opts: *gamemode_opts
    sources: *gamemode_sources

  - name: gamemoderun
    buildsystem: simple
    build-commands:
      - install -Dm755 data/gamemoderun -t /app/bin
    sources: *gamemode_sources
        
  - name: platform-bootstrap
    buildsystem: simple
    build-commands:
      - |
        set -e
        mkdir -p /app/bin
        mkdir -p /app/utils
        mkdir -p /app/lib/i386-linux-gnu
        mkdir -p /app/lib/debug/lib/i386-linux-gnu
        mkdir -p /app/lib/i386-linux-gnu/GL
        mkdir -p /app/lib/i386-linux-gnu/dri/intel-vaapi-driver
        install -D portproton /app/bin/portproton
        install -Dm644 com.castrofidel.portproton.png /app/share/icons/hicolor/128x128/apps/com.castrofidel.portproton.png
        install -Dm644 com.castrofidel.portproton.desktop /app/share/applications/${FLATPAK_ID}.desktop
        install -Dm644 -t /app/etc ld.so.conf
        #install -Dm644 $FLATPAK_ID.metainfo.xml /app/share/metainfo/$FLATPAK_ID.appdata.xml
    sources:
      - type: inline
        dest-filename: ld.so.conf
        contents: |
          /app/lib32
          /app/lib/i386-linux-gnu
      - type: file
        path: com.castrofidel.portproton.png
      - type: file
        path: com.castrofidel.portproton.desktop

  - name: desktop-file-utils
    build-options:
      no-debuginfo: true  
    buildsystem: autotools
    sources:
      - type: archive
        url: https://www.freedesktop.org/software/desktop-file-utils/releases/desktop-file-utils-0.26.tar.xz
        sha256: b26dbde79ea72c8c84fb7f9d870ffd857381d049a86d25e0038c4cef4c747309

  - name: vulkan-tools
    buildsystem: cmake-ninja
    config-opts:
      - -DGLSLANG_INSTALL_DIR=/app
      - -DVULKAN_HEADERS_INSTALL_DIR=/app
      - -DCMAKE_BUILD_TYPE=Release
    sources:
      - type: archive
        url: https://github.com/KhronosGroup/Vulkan-Tools/archive/refs/tags/v1.3.255.tar.gz
        sha256: ccd9175eec671b9ebff2486d1fb3e3d2f318028bbc873378ff9e1382b432abc6

  - name: icoutils
    build-options:
    no-debuginfo: true  
    buildsystem: autotools
    sources:
      - type: archive
        url: http://savannah.nongnu.org/download/icoutils/icoutils-0.32.3.tar.bz2
        mirror-urls: 
          - https://download-mirror.savannah.gnu.org/releases/icoutils/icoutils-0.32.3.tar.bz2
          - https://ftp.up.pt/pub/nongnu/icoutils/icoutils-0.32.3.tar.bz2
        sha256: 17abe02d043a253b68b47e3af69c9fc755b895db68fdc8811786125df564c6e0

  - name: cabextract
    build-options:
      strip: true
    sources:
      - type: archive
        url: https://www.cabextract.org.uk/cabextract-1.11.tar.gz
        sha256: b5546db1155e4c718ff3d4b278573604f30dd64c3c5bfd4657cd089b823a3ac6
        x-checker-data:
          type: anitya
          project-id: 245
          url-template: https://www.cabextract.org.uk/cabextract-$version.tar.gz

  # Libraries
  # ----------------------------------------------------------------------------

  - name: ImageMagick
    config-opts:
      - --disable-static
      - --disable-docs
      - --with-hdri
      - --with-pic
    sources:
      - type: archive
        url: https://github.com/ImageMagick/ImageMagick/archive/7.1.0-37.tar.gz
        sha256: a54888a1a46dbb808705a3e6c6b5ecb93ee30189a8ae6ea0f02300a0ab0d0996

  - name: libportal
    buildsystem: meson
    config-opts:
      - -Ddocs=false
      - -Dbackends=gtk4
    sources:
      - type: archive
        url: https://github.com/flatpak/libportal/archive/refs/tags/0.6.tar.gz
        sha256: 8ad326c4f53b7433645dc86d994fef0292bee8adda0fe67db9288ace19250a9c
  
  # Port Proton deps
  # ----------------------------------------------------------------------------
  
  - name: zenity
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/GNOME/zenity/archive/refs/tags/3.99.0.tar.gz
        sha256: b2c8fd9bdda9158f9b7b4ef8f33c97ae6e76806d035ae911c95fbcf9f0ccd6f6

  - name: bubblewrap
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/containers/bubblewrap/releases/download/v0.8.0/bubblewrap-0.8.0.tar.xz
        sha256: 957ad1149db9033db88e988b12bcebe349a445e1efc8a9b59ad2939a113d333a
